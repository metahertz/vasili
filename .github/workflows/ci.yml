name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff linter
        run: ruff check .

      - name: Run ruff formatter check
        run: ruff format --check .

  import-check:
    name: Import Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libiptc-dev wireless-tools

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check module imports
        run: |
          echo "Checking if modules can be imported..."
          python -c "
          import sys
          errors = []

          # Check main module syntax
          try:
              import ast
              with open('vasili.py', 'r') as f:
                  ast.parse(f.read())
              print('✓ vasili.py: syntax OK')
          except SyntaxError as e:
              errors.append(f'vasili.py: syntax error - {e}')
              print(f'✗ vasili.py: syntax error - {e}')

          # Check module files syntax
          import os
          for filename in os.listdir('modules'):
              if filename.endswith('.py'):
                  filepath = os.path.join('modules', filename)
                  try:
                      with open(filepath, 'r') as f:
                          ast.parse(f.read())
                      print(f'✓ modules/{filename}: syntax OK')
                  except SyntaxError as e:
                      errors.append(f'modules/{filename}: syntax error - {e}')
                      print(f'✗ modules/{filename}: syntax error - {e}')

          # Try importing the main module (may fail due to known issues)
          try:
              # Add current directory to path
              sys.path.insert(0, '.')
              import vasili
              print('✓ vasili module: import OK')
          except ImportError as e:
              errors.append(f'vasili module: import error - {e}')
              print(f'✗ vasili module: import error - {e}')
          except Exception as e:
              # Other errors (like missing wifi hardware) are expected in CI
              print(f'⚠ vasili module: runtime error (expected in CI) - {e}')

          if errors:
              print(f'\n{len(errors)} error(s) found')
              sys.exit(1)
          else:
              print('\nAll checks passed')
          "
